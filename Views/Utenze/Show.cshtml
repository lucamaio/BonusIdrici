@model IEnumerable<Models.ViewModels.UtenzeViewModel>

@{
    ViewData["Title"] = "Utenze Ente";
    var selectedEnteId = ViewBag.SelectedEnteId;
    var selectedEnteNome = ViewBag.SelectedEnteNome;
}

<div class="container-xxl flex-grow-1 py-5">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-sm border-0 rounded-4 w-100">
                <!-- Header -->
                <div class="card-header header-classic border-0 rounded-top-4 d-flex flex-column align-items-center p-4">
                    <div class="d-flex fw-bold justify-content-center align-items-center">
                        <i class="bi bi-droplet-fill me-2"></i>
                        <h3 class="fw-bold mb-0">Utenze - <span class="fw-semibold">@selectedEnteNome</span></h3>
                    </div>
                    <p class="mb-0 small opacity-75">ID Ente: <span class="fw-semibold">@selectedEnteId</span></p>
                </div>

                <!-- Barra di caricamento -->
                <div id="loadingBarContainer" class="progress rounded-0" style="height: 6px; display: none;">
                    <div id="loadingBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                         role="progressbar" style="width: 0%"></div>
                </div>

                <!-- Body -->
                <div class="card-body p-4 position-relative">
                    @if (Model != null && Model.Any())
                    {
                         <div class="row g-4 mb-4">
                            @{
                                var stats = new[]
                                {
                                    new { Icon="fa-droplet text-primary", Label="Totale Utenze", Value=ViewBag.TotaleUtenze },
                                    new { Icon="fa-user-plus text-success", Label="Utenze Iscrivendo/Iscritti", Value=ViewBag.UtenzeIscrivendo },
                                    new { Icon="fa-user-minus text-danger", Label="Utenze Cancellando/Cancellato", Value=ViewBag.UtenzeCancellate },
                                    new { Icon="fa-arrows-rotate text-warning", Label="Iscrivendo/Cancellando", Value=ViewBag.UtenzeIscrivendoCancellando },
                                    new { Icon="fa-house text-primary", Label="Utenze Domestiche", Value=ViewBag.UtenzeDomestiche },
                                    new { Icon="fa-building text-secondary", Label="Utenze Non Domestiche", Value=ViewBag.UtenzeNonDomestiche }
                                };
                            }
                            @foreach (var s in stats)
                            {
                                <div class="col-6 col-md-4 col-lg-4">
                                    <div class="card border-0 shadow-sm stat-card text-center h-100 hover-shadow">
                                        <div class="card-body py-4">
                                            <div class="icon-circle mx-auto mb-3 bg-light shadow-sm">
                                                <i class="fa-solid @s.Icon fs-4"></i>
                                            </div>
                                            <h6 class="fw-semibold mb-1">@s.Label</h6>
                                            <h4 class="fw-bold text-dark mb-0">@s.Value</h4>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        
                       <div class="info-text mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <span>Di seguito sono elencate tutte le utenze idriche registrate per l'ente selezionato.</span>
                        </div>

                        <div class="d-flex justify-content-end mb-3">
                        <a href="@Url.Action("Create", "Utenze")" class="btn btn-modern-add shadow-sm">
                            <i class="bi bi-plus-circle me-2"></i> Aggiungi Utenza
                        </a>
                    </div>

                        <div class="table-responsive w-100" id="tableWrapper" style="display: none;"> <!-- nascosta finchÃ© carica -->
                            <table id="utenzeTable" class="table table-hover align-middle border-bottom w-100 rounded-3 shadow-sm">
                                <thead>
                                    <tr>
                                        <th class="text-center">Id Acquedotto</th>
                                        <th class="text-center">Matricola</th>
                                        <th class="text-center">Detentore</th>
                                        <th class="text-center">Situato</th>
                                        <th class="text-center">Tipo</th>
                                        <th class="text-center">Stato</th>
                                        <th class="text-center">Azioni</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        string detentore = item.cognome + " " + item.nome;
                                        string sito = item.indirizzoUbicazione + ", " + item.numeroCivico;
                                        string statoUtenza = FunzioniTrasversali.getStatoStringUtenza(item.stato);
                                       
                                        detentore = FunzioniTrasversali.MaiuscoleIniziali(detentore);
                                        sito = FunzioniTrasversali.MaiuscoleIniziali(sito);
                                        <tr>
                                            <td class="text-center">@item.idAcquedotto</td>
                                            <td class="text-center">@item.matricolaContatore</td>
                                            <td>@detentore</td>
                                            <td>@sito</td>
                                            <td>
                                                @{
                                                    switch (item.tipoUtenza)
                                                    {
                                                        case "UTENZA NON DOMESTICA":
                                                            <span>Non Domestica</span>;
                                                            break;
                                                        case "UTENZA DOMESTICA":
                                                            <span>Domestica</span>
                                                            break;
                                                        case "UTENZA COMMERCIALE":
                                                            <span>Commerciale</span>;
                                                            break;
                                                        case "UTENZA USO ARTIGIANALE":
                                                            <span>Uso Artigianale</span>;
                                                            break;
                                                        case "UTENZA SPECIALE TEMPORANEA":
                                                            <span>Speciale Temporanea</span>;
                                                            break;
                                                        case "UTENZA USO INDUSTRIALE":
                                                            <span>Uso Industriale</span>;
                                                            break;
                                                        default:
                                                            <span>@item.tipoUtenza</span>;
                                                            break;
                                                    }
                                                }
                                            </td>
                                            <td class="text-center">
                                                <span class="">@statoUtenza</span>
                                            </td>
                                            <td class="text-center">
                                               <a class="btn btn-modern-edit btn-sm" title="Modifica Utenza"
                                                href="@Url.Action("Modifica", "Utenze", new { id = item.id })">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center shadow-sm rounded-3">
                            <i class="bi bi-exclamation-triangle me-2"></i> Nessun dato di utenze trovato per l'ente selezionato.
                        </div>
                    }

                    @if(ViewBag.Ruolo != "OPERATORE"){
                        <div class="d-grid mt-4">
                            <a href="@Url.Action("Index", "Utenze")" class="btn btn-outline-secondary btn-lg shadow-sm">
                                <i class="bi bi-arrow-left-circle me-2"></i> Torna alla Selezione Ente
                            </a>
                        </div>
                    }else{
                        <div class="d-grid mt-4">
                        <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary btn-lg shadow-sm">
                            <i class="bi bi-arrow-left-circle me-2"></i> Torna alla Home
                        </a>
                    </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
   <script>
$(document).ready(function () {
    $("#loadingBarContainer").show();
    var progress = 0;
    var interval = setInterval(function () {
        if (progress < 90) {
            progress += 10;
            $("#loadingBar").css("width", progress + "%");
        }
    }, 300);

    var utenzeTable = $('#utenzeTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        language: { url: "https://cdn.datatables.net/plug-ins/2.0.8/i18n/it-IT.json" },
        dom: '<"d-flex justify-content-between align-items-center mb-3"l f>t<"row mt-3"<"col-sm-6"i><"col-sm-6 text-end"p>>',
        buttons: [],
        drawCallback: function (settings) {
            var api = this.api();
            var pages = api.page.info().pages;
            if (pages <= 1) {
                $(api.table().container()).find('.dataTables_paginate').hide();
                $(api.table().container()).find('.dataTables_length').hide();
            } else {
                $(api.table().container()).find('.dataTables_paginate').show();
                $(api.table().container()).find('.dataTables_length').show();
            }
        }
    });


    utenzeTable.on('init', function () {
        clearInterval(interval);
        $("#loadingBar").css("width", "100%");
        setTimeout(function () {
            $("#loadingBarContainer").fadeOut();
            $("#tableWrapper").fadeIn();
        }, 500);
    });
});
</script>
}